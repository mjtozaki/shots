<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-url/2.5.3/url.min.js"></script>
  <script type="text/javascript">
    "use strict";
    var GoogleAuth;
    var SCOPE = 'https://www.googleapis.com/auth/drive.readonly';
//       SCOPE += ' https://www.googleapis.com/auth/drive.appdata';
    
    function gapi_loaded() {
      console.log('Loading gapi');
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      console.log('Loaded gapi');
      
      var good = true;
      var apiKey = url('?api_key');
      var clientId = url('?client_id');
      
      if (apiKey === undefined) {
        window.alert("api_key parameter must be set.");
        good = false;
      }
      if (clientId === undefined) {
        window.alert("client_id parameter must be set.");
        good = false;
      }
      if (!good) {
        return;
      }

      // 2. Initialize the JavaScript client library.
      gapi.client.init({
        'apiKey': apiKey,
        // Your API key will be automatically added to the Discovery Document URLs.
//         'discoveryDocs': ['https://people.googleapis.com/$discovery/rest'],
        // clientId and scope are optional if auth is not required.
        'clientId': clientId,
        'scope': SCOPE,
      })
        .then(
          function() {
            var needToSignIn = true;
            GoogleAuth = gapi.auth2.getAuthInstance();
            if (GoogleAuth.isSignedIn.get()) {
              var user = GoogleAuth.currentUser.get();
              var isAuthorized = user.hasGrantedScopes(SCOPE);
              if (!isAuthorized) {
                console.log("Signed in and not authorized.");
              } else {
                needToSignIn = false;
                console.log("Signed in and authorized!");
              }
            } else {
              console.log("Not signed in.");
            }
            if (needToSignIn) {
              return GoogleAuth.signIn({
                'prompt': 'consent',
              });
            }
            return Promise.resolve("doesn't matter");
          })
        .then(
          function() {
            // 3. Initialize and make the API request.
            console.log('Requesting files.list');
            return gapi.client.request({
              'path': 'https://www.googleapis.com/drive/v3/files',
              'params': {
                'spaces': 'drive' /*,appDataFolder*/,
                'q': "name contains '.shot'",
              },
            });
          },
          function(reason) {
            console.log('Error: ' + reason);
    //         console.log('Error: ' + reason.result.error.message);
          })
        .then(
          function(response) {
            // File listing
            console.log(response.result);
            
            // Now take first result and lets get its contents
            var fileId = response.result.files[0].id;
            return gapi.client.request({
              'path': 'https://www.googleapis.com/drive/v3/files/' + fileId,
              'params': {
                 'alt': 'media',
              },
            });
          },
          function(reason) {
            console.log('Error: ' + reason.result.error.message);
          })
        .then(
          function(response) {
            console.log(response);
            $("#file_contents").html(textToHtml(response.body));
          },
          function(reason) {
            console.log('Error: ' + reason);
//             console.log('Error: ' + reason.result.error.message);
          });

    }
    
    function textToHtml(text) {
      return text.replace('\n', '<br>');
    }
  </script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=gapi_loaded"></script>

</head>
<body>
  <h3>Hello World</h3>
  <div id="file_contents"></div>
</body>
</html>
